<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solutions in Focus — US Community Efforts</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --panel: #111;
      --base: #eaeaea;
      --muted: #9a9a9a;
      --accent: #e63946;
      --accent-2: #ffffff;
      --map-fill: #ffffff;
      --map-stroke: #cccccc;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--base); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .map-wrap { max-width: 1100px; margin: 0 auto; padding: 24px clamp(12px, 3vw, 32px); }
    .content-layout { display: flex; gap: 20px; }
    .panel { background: linear-gradient(180deg, var(--panel), #0e0e0e); border: 1px solid #1e1e1e; border-radius: 16px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,.35); flex: 1; }
    .info-panel { background: linear-gradient(180deg, var(--panel), #0e0e0e); border: 1px solid #1e1e1e; border-radius: 16px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,.35); width: 300px; min-height: 400px; }
    .header { display:flex; align-items:center; justify-content:space-between; padding: 12px 14px; border-bottom: 1px solid #1e1e1e; }
    .header h2 { font-size: 16px; margin: 0; color: var(--accent-2); }
    .controls { display:flex; gap: 8px; }
    .btn { background: #161616; color: var(--base); border: 1px solid #2b2b2b; border-radius: 999px; padding: 6px 12px; cursor: pointer; font-weight: 600; }
    .btn:hover { border-color: #3b3b3b; }
    .map { width: 100%; aspect-ratio: 16/9; display:block; background: radial-gradient(1000px 500px at 50% -200px, #1a1a1a, #0f0f0f 60%); position: relative; }
    svg { width:100%; height:100%; display:block; }
    .state { fill: var(--map-fill); stroke: var(--map-stroke); stroke-width: .7px; }
    .state:hover { fill: #f5f5f5; }
    .state.highlighted { fill: var(--accent); stroke: var(--accent-2); stroke-width: 1.5px; }
    .site { fill: var(--accent-2); stroke: var(--bg); stroke-width: 1px; }
    .site:hover, .site.selected { fill: var(--accent); stroke: var(--accent-2); }
    .footer { display:flex; align-items:center; justify-content:space-between; padding: 8px 12px; border-top: 1px solid #1e1e1e; color: var(--muted)}
    .legend { display:flex; align-items:center; gap:12px }
    .legend .chip { width: 10px; height: 10px; border-radius: 999px; display:inline-block; }
    .tip { position: absolute; pointer-events: none; background: #0e0e0e; color: var(--base); border: 1px solid #222; padding: 12px 14px; border-radius: 12px; font-size: 13px; box-shadow: 0 8px 24px rgba(0,0,0,.4); opacity: 0; transform: translate(-50%, -100%); transition: opacity .2s ease; max-width: 320px; line-height: 1.4; }
    .tip .name { font-weight: 700; color: var(--accent-2); font-size: 14px; margin-bottom: 4px; }
    .tip .city { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .tip .metric { color: var(--accent); font-weight: 700; margin-bottom: 6px; }
    .tip .blurb { color: var(--base); font-size: 12px; }
    .tip .efforts { margin-top: 8px; padding-top: 8px; border-top: 1px solid #222; }
    .tip .efforts-title { color: var(--accent-2); font-weight: 600; font-size: 12px; margin-bottom: 4px; }
    .info-content { color: var(--base); }
    .info-content h3 { color: var(--accent-2); margin: 0 0 10px 0; font-size: 18px; }
    .info-content .location { color: var(--muted); font-size: 14px; margin-bottom: 10px; }
    .info-content .metric { color: var(--accent); font-weight: 700; margin-bottom: 15px; font-size: 16px; }
    .info-content .description { margin-bottom: 15px; line-height: 1.4; }
    .info-content .impact-title { color: var(--accent-2); font-weight: 600; margin-bottom: 8px; }
    .info-content .impact { line-height: 1.4; }
    .info-placeholder { color: var(--muted); text-align: center; margin-top: 50px; }
  </style>
</head>
<body>
  <div class="map-wrap">
    <div class="panel">
      <div class="header">
        <h2>Solutions in Focus — U.S. Community Efforts</h2>
        <div class="controls">
          <button class="btn" id="resetBtn">Reset</button>
          <button class="btn" id="playBtn">Play tour</button>
        </div>
      </div>
      <div class="map" id="map">
        <svg role="img" aria-label="Map of U.S. community overdose prevention efforts">
          <g id="basemap"></g>
          <g id="markers"></g>
        </svg>
        <div class="tip" id="tip"></div>
      </div>
      <div class="footer">
        <div class="legend">
          <span class="chip" style="background: var(--accent-2);"></span>
          <span>Community initiative</span>
          <span class="chip" style="background: var(--accent);"></span>
          <span>Selected</span>
        </div>
        <small>Click a dot to focus. Red = highlighted story.</small>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
  <script>
  (function() {
    const svg = d3.select('svg');
    const gBase = svg.select('#basemap');
    const gMarks = svg.select('#markers');
    const tip = d3.select('#tip');
    const projection = d3.geoAlbersUsa();
    const path = d3.geoPath(projection);
    const zoom = d3.zoom().scaleExtent([1, 12]).on('zoom', (event) => {
      gBase.attr('transform', event.transform);
      gMarks.attr('transform', event.transform);
    });
    svg.call(zoom);
    const resize = () => {
      const { width, height } = svg.node().getBoundingClientRect();
      projection.fitExtent([[10, 10], [width-10, height-10]], {type:'Sphere'});
      gBase.selectAll('path').attr('d', path);
      gMarks.selectAll('circle')
        .attr('cx', d => projection([d.lon, d.lat])[0])
        .attr('cy', d => projection([d.lon, d.lat])[1]);
    };
    new ResizeObserver(resize).observe(svg.node());
    function flyToPoint([lon, lat], duration=1000) {
      const [x, y] = projection([lon, lat]);
      const { width, height } = svg.node().getBoundingClientRect();
      const scale = 6;
      const translate = [width/2 - scale * x, height/2 - scale * y];
      svg.transition().duration(duration)
        .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
    }
    function resetView() {
      svg.transition().duration(900).call(zoom.transform, d3.zoomIdentity);
      d3.selectAll('.selected').classed('selected', false);
      window.parent.postMessage({type: 'programReset'}, '*');
    }
    d3.select('#resetBtn').on('click', resetView);
    const US_TOPO = 'https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json';
    const communitySites = [
      { id: 'oh-dayton', name: 'County CARE Coalition', city: 'Dayton, OH', lon: -84.1916, lat: 39.7589, metric: 'Naloxone +45%', blurb: 'Door-to-door naloxone training with barbershops + libraries.', efforts: 'Training 200+ community members monthly, partnering with 15 local barbershops and 8 libraries for naloxone distribution and education.' },
      { id: 'ma-boston', name: 'Bridge to Care', city: 'Boston, MA', lon: -71.0589, lat: 42.3601, metric: 'OD deaths −15%', blurb: '24/7 naloxone lockers + community responders.', efforts: 'Installed 50 naloxone lockers citywide, trained 300 community responders, providing 24/7 emergency response coordination.' },
      { id: 'wa-seattle', name: "People’s Harm Reduction Alliance (PHRA)", city: 'Seattle, WA', lon: -122.3321, lat: 47.6062, metric: '54,000+ naloxone kits (state mail program)', blurb: 'Peer-led outreach + statewide mail-order naloxone for WA DOH.', efforts: 'Manages WA’s mail-order naloxone; provides syringe services, trainings, and community outreach.'},

      { id: 'ca-losangeles',
        name: 'Homeless Health Care Los Angeles — Center for Harm Reduction (HHCLA)',
        city: 'Los Angeles, CA', lon: -118.2437, lat: 34.0522,
        metric: 'County OEND + daily outreach (LA County)',
        blurb: 'Large community harm-reduction hub with naloxone and syringe services.',
        efforts: 'Naloxone distribution, overdose prevention training, drop-in services, linkage to housing and care.'
      },

      { id: 'tx-austin',
        name: 'Texas Harm Reduction Alliance (THRA) — Austin/Travis partnership',
        city: 'Austin, TX', lon: -97.7431, lat: 30.2672,
        metric: 'OD deaths −22% in 2024 (countywide)',
        blurb: 'Street outreach + naloxone with city/county partners.',
        efforts: 'Peer support, naloxone distribution, education; part of Austin Public Health’s overdose response hub.'
      },

      { id: 'il-chicago',
        name: 'Chicago Recovery Alliance (CRA)',
        city: 'Chicago, IL', lon: -87.6298, lat: 41.8781,
        metric: '200+ drug samples checked in 2024 (city program)',
        blurb: 'Pioneer of community naloxone + mobile outreach.',
        efforts: 'Naloxone training/distribution, drug checking with CDPH-funded network, daily van outreach.'
      },

      { id: 'fl-miami',
        name: 'IDEA Exchange Miami (Univ. of Miami)',
        city: 'Miami, FL', lon: -80.1918, lat: 25.7617,
        metric: 'Up to 10,000 syringes exchanged weekly',
        blurb: 'Syringe services + free naloxone and FTS; fixed and mobile sites.',
        efforts: '3 fixed + 5 mobile sites; anonymous services, HIV/HCV testing, wound care, naloxone distribution.'
      },

      { id: 'co-denver',
        name: 'Harm Reduction Action Center (HRAC)',
        city: 'Denver, CO', lon: -104.9903, lat: 39.7392,
        metric: '7,284 naloxone doses supplied (one year)',
        blurb: 'Denver’s main harm-reduction drop-in and outreach program.',
        efforts: 'Daily syringe access, naloxone distribution, community trainings; city overdose prevention partner.'
      },

      { id: 'ny-newyork',
        name: 'OnPoint NYC — Overdose Prevention Centers',
        city: 'New York, NY', lon: -74.0060, lat: 40.7128,
        metric: '1,700+ overdose reversals since 2021',
        blurb: 'Supervised consumption with medical monitoring and wraparound care.',
        efforts: 'Two OPCs (East Harlem/Washington Heights), on-site responses, care navigation, street outreach.'
      },

      { id: 'ga-atlanta',
        name: 'Georgia Harm Reduction Coalition (GHRC)',
        city: 'Atlanta, GA', lon: -84.3880, lat: 33.7490,
        metric: '4 SSP sites + mail naloxone',
        blurb: 'Metro Atlanta syringe services and overdose prevention.',
        efforts: 'Multiple locations; naloxone shipping via Dan Bigg Distribution Center; community outreach and FTS.'
      },

      { id: 'co-denver-city',
        name: 'Denver Public Health & Environment — OEND Program',
        city: 'Denver, CO', lon: -104.9903, lat: 39.7392,
        metric: 'City OEND program active',
        blurb: 'Municipal overdose education & naloxone distribution.',
        efforts: 'Community trainings, naloxone access, harm-reduction education; collaborates with local venues and HRAC.'
      }
    ];
    Promise.all([d3.json(US_TOPO)]).then(([topology]) => {
      const states = topojson.feature(topology, topology.objects.states);
      gBase.selectAll('path').data(states.features)
        .join('path')
        .attr('class', 'state')
        .attr('d', path);
      gMarks.selectAll('circle').data(communitySites, d => d.id)
        .join('circle')
        .attr('class', 'site')
        .attr('r', 4)
        .attr('cx', d => projection([d.lon, d.lat])[0])
        .attr('cy', d => projection([d.lon, d.lat])[1])
        .on('click', function(event, d){
          d3.selectAll('.site').classed('selected', false);
          d3.select(this).classed('selected', true);
          flyToPoint([d.lon, d.lat]);
          window.parent.postMessage({type: 'programSelected', data: d}, '*');
        });
      resize();
      let playing = false; let idx = 0; let timer;
      function playTour(){
        if (playing) return; playing = true;
        d3.select('#playBtn').text('Pause tour');
        timer = d3.interval(() => {
          const d = communitySites[idx % communitySites.length];
          gMarks.selectAll('circle').filter(m => m.id === d.id).dispatch('click');
          idx++;
        }, 2200);
      }
      function pauseTour(){ playing = false; d3.select('#playBtn').text('Play tour'); if (timer) timer.stop(); }
      d3.select('#playBtn').on('click', () => playing ? pauseTour() : playTour());
    });
  })();
  </script>
</body>
</html>
